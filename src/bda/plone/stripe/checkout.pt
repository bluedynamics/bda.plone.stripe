<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bda.plone.stripe">

<head>
  <metal:top fill-slot="top_slot">
    <tal:border define="dummy python:request.set('disable_border', True)" />

  <style type="text/css">

    form#payment-form {
      width: 480px;
      margin: 20px 0;
    }

    .StripeElement {
      height: 40px;
      padding: 10px 12px;
      width: 100%;
      color: #32325d;
      background-color: white;
      border: 1px solid transparent;
      border-radius: 4px;

      box-shadow: 0 1px 3px 0 #e6ebf1;
      -webkit-transition: box-shadow 150ms ease;
      transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
      box-shadow: 0 1px 3px 0 #cfd7df;
    }

    .StripeElement--invalid {
      border-color: #fa755a;
    }

    .StripeElement--webkit-autofill {
      background-color: #fefde5 !important;
}

  </style>

  </metal:top>
</head>

<body>

<metal:main fill-slot="main">
  <tal:main-macro metal:define-macro="main">

    <h1 class="documentFirstHeading" i18n:translate="credit_card_information">
      Enter credit card information
    </h1>

    <form id='payment-form'>
      <label style="min-width: 50%;">
        Card details
        <!-- placeholder for Elements -->
        <div id="card-element"></div>
      </label>
      <button type="submit" i18n:translate="bezahlen">Kostenpflichtig bezahlen</button>
    </form>

    <script src="https://js.stripe.com/v3/"></script>

    <script tal:content="view/checkout_settings">
      var stripe_api_key = 'pk_test_6pRNASCoBOKtIshFeQd4XMUh';
      var order_uid = '46052806-79cc-4201-8e1b-3f0d1a6ed5fe';
      var lang = '46052806-79cc-4201-8e1b-3f0d1a6ed5fe';
    </script>

    <script>
    window.onload = function() {
      var stripe = Stripe(stripe_api_key, {
        locale: lang
      });
      var elements = stripe.elements();
      var style = {
        base: {
          color: "#32325d",
          fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
          fontSmoothing: "antialiased",
          fontSize: "16px",
          "::placeholder": {
            color: "#aab7c4"
          }
        },
        invalid: {
          color: "#fa755a",
          iconColor: "#fa755a"
        },
      };

      var cardElement = elements.create('card', {style: style});
      cardElement.mount('#card-element');

      function stripePaymentMethodHandler(result) {
        if (result.error) {
          // Show error in payment form
        } else {
          // Otherwise send paymentMethod.id to your server (see Step 4)
          fetch('./stripe_charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payment_method_id: result.paymentMethod.id,
              order_uid: order_uid
            })
          }).then(function(result) {
            // Handle server response (see Step 4)
            result.json().then(function(json) {
              handleServerResponse(json);
            })
          });
        }
      }

      var form = $('#payment-form');
      form.on('submit', function(event) {
        // We don't want to let default form submission happen here,
        // which would refresh the page.
        event.preventDefault();

        stripe.createPaymentMethod({
          type: 'card',
          card: cardElement,
          billing_details: {
            // Include any additional collected billing details.
            name: order_uid,
          },
        }).then(stripePaymentMethodHandler);
      });

      function handleServerResponse(response) {
        if (response.error) {
          window.location = './@@stripe_payment_failed?message=' + response.error;
        } else if (response.requiresAction) {
          // Use Stripe.js to handle required card action
          stripe.handleCardAction(
            response.clientSecret
          ).then(handleStripeJsResult);
        } else {
          window.location = './@@stripe_payment_success';
        }
      }

      function handleStripeJsResult(result) {
        if (result.error) {
          // Show error in payment form
        } else {
          // The card action has been handled
          // The PaymentIntent can be confirmed again on the server
          fetch('./stripe_charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              payment_intent_id: result.paymentIntent.id,
              order_uid: order_uid
            })
          }).then(function(confirmResult) {
            return confirmResult.json();
          }).then(handleServerResponse);
        }
      }

    };
    </script>

  </tal:main-macro>
</metal:main>

</body>
</html>
