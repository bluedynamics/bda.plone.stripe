<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="bda.plone.stripe">

<head>
  <metal:top fill-slot="top_slot">
    <tal:border define="dummy python:request.set('disable_border', True)" />

  <style type="text/css">

    form#payment-form {
      width: 480px;
      margin: 20px 0;
    }

    .group {
      background: white;
      box-shadow: 0 7px 14px 0 rgba(49, 49, 93, 0.10), 0 3px 6px 0 rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      margin-bottom: 20px;
    }

    label {
      position: relative;
      color: #8898AA;
      font-weight: 300;
      height: 40px;
      line-height: 40px;
      margin-left: 20px;
      display: flex;
      flex-direction: row;
    }

    .group label:not(:last-child) {
      border-bottom: 1px solid #F0F5FA;
    }

    label > span {
      width: 120px;
      text-align: right;
      margin-right: 30px;
    }

    .field {
      background: transparent;
      font-weight: 300;
      border: 0;
      color: #31325F;
      outline: none;
      flex: 1;
      padding-right: 10px;
      padding-left: 10px;
      cursor: text;
    }

    .field::-webkit-input-placeholder {
      color: #CFD7E0;
    }

    .field::-moz-placeholder {
      color: #CFD7E0;
    }

    button {
      float: left;
      display: block;
      background: #666EE8;
      color: white;
      box-shadow: 0 7px 14px 0 rgba(49, 49, 93, 0.10), 0 3px 6px 0 rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      border: 0;
      margin-top: 20px;
      font-size: 15px;
      font-weight: 400;
      width: 100%;
      height: 40px;
      line-height: 38px;
      outline: none;
    }

    button:focus {
      background: #555ABF;
    }

    button:active {
      background: #43458B;
    }

    .outcome {
      float: left;
      width: 100%;
      padding-top: 8px;
      min-height: 24px;
      text-align: center;
    }

    .success,
    .error {
      display: none;
      font-size: 13px;
    }

    .success.visible,
    .error.visible {
      display: inline;
    }

    .error {
      color: #E4584C;
    }

    .success {
      color: #666EE8;
    }

    .success .token {
      font-weight: 500;
      font-size: 13px;
    }


  </style>

  </metal:top>
</head>

<body>

<metal:main fill-slot="main">
  <tal:main-macro metal:define-macro="main">

    <h1 class="documentFirstHeading" i18n:translate="credit_card_information">
      Enter credit card information
    </h1>

    <form action="${context/absolute_url}/stripe_charge" method="post" id="payment-form">
      <!-- <input type="text" id="card-holder-name", name="card-holder-name", value="" /> -->
<!--       <div class="form-row">
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
      </div>
      <button style="margin-top: 1em;">Submit Payment</button> -->

      <div class="group">
        <label>
          <span>Card number</span>
          <div id="card-number-element" class="field"></div>
        </label>
        <label>
          <span>Expiry date</span>
          <div id="card-expiry-element" class="field"></div>
        </label>
        <label>
          <span>CVC</span>
          <div id="card-cvc-element" class="field"></div>
        </label>
        <label>
          <span>Name</span>
          <div id="card-holder-element" class="field"></div>
        </label>
      </div>
      <button type="submit">Pay $25</button>
      <div class="outcome">
        <div class="error"></div>
        <div class="success">
          Success! Your Stripe token is <span class="token"></span>
        </div>
      </div>

    </form>

    <script src="https://js.stripe.com/v3/"></script>

    <script tal:content="view/checkout_settings">
      var stripe_api_key = 'pk_test_6pRNASCoBOKtIshFeQd4XMUh';
      var order_uid = '46052806-79cc-4201-8e1b-3f0d1a6ed5fe';
    </script>

    <script>
      var stripe = Stripe(stripe_api_key);
      var elements = stripe.elements();

      // Custom styling can be passed to options when creating an Element.
      var style = {
        base: {
          iconColor: '#666EE8',
          color: '#31325F',
          lineHeight: '40px',
          fontWeight: 300,
          fontSize: '15px',

          '::placeholder': {
            color: '#CFD7E0',
          },
        },
      };

      // Create an instance of the card Element
      // var card = elements.create('card', {style: style});

      // Add an instance of the card Element into the `card-element` div
      // card.mount('#card-element');

      var cardNumberElement = elements.create('cardNumber', {
        style: style
      });
      cardNumberElement.mount('#card-number-element');

      var cardExpiryElement = elements.create('cardExpiry', {
        style: style
      });
      cardExpiryElement.mount('#card-expiry-element');

      var cardCvcElement = elements.create('cardCvc', {
        style: style
      });
      cardCvcElement.mount('#card-cvc-element');

      var cardHolderElement = elements.create('cardHolder', {
        style: style
      });
      cardHolder.mount('#card-holder-element');

      card.addEventListener('change', function(event) {
        var displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });

      // Create a token or display an error when the form is submitted.
      var form = document.getElementById('payment-form');
      form.addEventListener('submit', function(event) {
        event.preventDefault();

        var card_holder = document.getElementById('card-holder-name').value;
        cart_data = {
          name: card_holder
        };

        stripe.createToken(card, cart_data).then(function(result) {
          if (result.error) {
            // Inform the user if there was an error
            var errorElement = document.getElementById('card-errors');
            errorElement.textContent = result.error.message;
          } else {
            // Send the token to your server
            stripeTokenHandler(result.token);
          }
        });
      });

      function stripeTokenHandler(token) {
        var form = document.getElementById('payment-form');

        // Insert the order UID into the form
        var uid = document.createElement('input');
        uid.setAttribute('type', 'hidden');
        uid.setAttribute('name', 'uid');
        uid.setAttribute('value', order_uid);
        form.appendChild(uid);

        // Insert the token ID into the form
        var tokenId = document.createElement('input');
        tokenId.setAttribute('type', 'hidden');
        tokenId.setAttribute('name', 'stripeToken');
        tokenId.setAttribute('value', token.id);
        form.appendChild(tokenId);

        // Submit the form
        form.submit();
      }
    </script>

  </tal:main-macro>
</metal:main>

</body>
</html>
